{% extends 'base.html' %}
{% load static %}

{% block title %}Application Details - {{ application.get_full_name }} - ElevatePro Internships{% endblock %}

{% block extra_css %}
<style>
    .application-header {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 15px 15px;
    }
    
    .info-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 2rem;
        margin-bottom: 2rem;
        border-left: 4px solid #f39c12;
    }
    
    .status-badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
        border: 2px solid #ffeaa7;
    }
    
    .status-approved {
        background-color: #d4edda;
        color: #155724;
        border: 2px solid #00b894;
    }
    
    .status-rejected {
        background-color: #f8d7da;
        color: #721c24;
        border: 2px solid #e17055;
    }
    
    .status-intern_created {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 2px solid #00cec9;
    }
    
    .action-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #dee2e6;
    }
    
    .file-link {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: #e9ecef;
        border-radius: 20px;
        text-decoration: none;
        color: #495057;
        margin: 0.25rem;
        transition: all 0.3s ease;
    }
    
    .file-link:hover {
        background: #f39c12;
        color: white;
        text-decoration: none;
    }
    
    .timeline-item {
        border-left: 3px solid #f39c12;
        padding-left: 1.5rem;
        margin-bottom: 1.5rem;
        position: relative;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -8px;
        top: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #f39c12;
    }
    
    .notes-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        border-left: 4px solid #6c757d;
    }
    
    .action-buttons .btn {
        margin: 0.25rem;
        min-width: 120px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Application Header -->
<div class="application-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">{{ application.get_full_name }}</h1>
                <p class="mb-1">
                    <i class="fas fa-briefcase me-2"></i>
                    {{ application.internship.title }}
                </p>
                <p class="mb-0">
                    <i class="fas fa-calendar me-2"></i>
                    Applied on {{ application.submitted_at|date:"F d, Y \a\t g:i A" }}
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="status-badge status-{{ application.status }}">
                    <i class="fas fa-circle me-2"></i>
                    {{ application.get_status_display }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Personal Information -->
            <div class="info-card">
                <h4 class="mb-3">
                    <i class="fas fa-user text-primary me-2"></i>
                    Personal Information
                </h4>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Full Name:</strong> {{ application.get_full_name }}</p>
                        <p><strong>Email:</strong> {{ application.email }}</p>
                        <p><strong>Phone:</strong> {{ application.phone }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Date of Birth:</strong> {{ application.date_of_birth|date:"F d, Y" }}</p>
                        <p><strong>Gender:</strong> {{ application.get_gender_display }}</p>
                        <p><strong>Address:</strong> {{ application.address }}</p>
                    </div>
                </div>
            </div>

            <!-- Academic Information -->
            <div class="info-card">
                <h4 class="mb-3">
                    <i class="fas fa-graduation-cap text-primary me-2"></i>
                    Academic Information
                </h4>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Institution:</strong> {{ application.institution }}</p>
                        <p><strong>Field of Study:</strong> {{ application.field_of_study }}</p>
                        <p><strong>Current Level:</strong> {{ application.get_current_level_display }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>GPA:</strong> {{ application.gpa|default:"Not provided" }}</p>
                        <p><strong>Expected Graduation:</strong> {{ application.expected_graduation|date:"F Y" }}</p>
                    </div>
                </div>
            </div>

            <!-- Internship Details -->
            <div class="info-card">
                <h4 class="mb-3">
                    <i class="fas fa-briefcase text-primary me-2"></i>
                    Internship Applied For
                </h4>
                <div class="row">
                    <div class="col-md-8">
                        <h5>{{ application.internship.title }}</h5>
                        <p class="text-muted mb-2">{{ application.internship.department }} â€¢ {{ application.internship.location }}</p>
                        <p>{{ application.internship.description|truncatewords:30 }}</p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Type:</strong> {{ application.internship.get_internship_type_display }}</p>
                        <p><strong>Duration:</strong> {{ application.internship.get_duration_display }}</p>
                        {% if application.internship.salary_amount %}
                            <p><strong>Salary:</strong> {{ application.internship.salary_amount|floatformat:0 }} CFA/month</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Cover Letter & Motivation -->
            {% if application.cover_letter %}
                <div class="info-card">
                    <h4 class="mb-3">
                        <i class="fas fa-file-alt text-primary me-2"></i>
                        Cover Letter
                    </h4>
                    <div class="bg-light p-3 rounded">
                        {{ application.cover_letter|linebreaks }}
                    </div>
                </div>
            {% endif %}

            <!-- Skills & Experience -->
            {% if application.skills or application.experience %}
                <div class="info-card">
                    <h4 class="mb-3">
                        <i class="fas fa-tools text-primary me-2"></i>
                        Skills & Experience
                    </h4>
                    {% if application.skills %}
                        <div class="mb-3">
                            <h6>Skills:</h6>
                            <p>{{ application.skills }}</p>
                        </div>
                    {% endif %}
                    {% if application.experience %}
                        <div>
                            <h6>Experience:</h6>
                            <p>{{ application.experience|linebreaks }}</p>
                        </div>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Documents -->
            <div class="info-card">
                <h4 class="mb-3">
                    <i class="fas fa-paperclip text-primary me-2"></i>
                    Submitted Documents
                </h4>
                <div class="row">
                    {% if application.cv %}
                        <div class="col-md-4 mb-2">
                            <a href="{{ application.cv.url }}" target="_blank" class="file-link">
                                <i class="fas fa-file-pdf me-2"></i>
                                CV/Resume
                            </a>
                        </div>
                    {% endif %}
                    {% if application.cover_letter_file %}
                        <div class="col-md-4 mb-2">
                            <a href="{{ application.cover_letter_file.url }}" target="_blank" class="file-link">
                                <i class="fas fa-file-alt me-2"></i>
                                Cover Letter
                            </a>
                        </div>
                    {% endif %}
                    {% if application.transcript %}
                        <div class="col-md-4 mb-2">
                            <a href="{{ application.transcript.url }}" target="_blank" class="file-link">
                                <i class="fas fa-file-text me-2"></i>
                                Transcript
                            </a>
                        </div>
                    {% endif %}
                    {% if application.portfolio %}
                        <div class="col-md-4 mb-2">
                            <a href="{{ application.portfolio.url }}" target="_blank" class="file-link">
                                <i class="fas fa-folder me-2"></i>
                                Portfolio
                            </a>
                        </div>
                    {% endif %}
                    {% if not application.cv and not application.cover_letter_file and not application.transcript and not application.portfolio %}
                        <div class="col-12">
                            <p class="text-muted">No documents submitted</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            {% if application.status == 'pending' %}
                <div class="action-card">
                    <h5 class="mb-3">Quick Actions</h5>
                    <div class="action-buttons text-center">
                        <button class="btn btn-success" onclick="approveApplication()">
                            <i class="fas fa-check me-1"></i>
                            Approve
                        </button>
                        <button class="btn btn-danger" onclick="rejectApplication()">
                            <i class="fas fa-times me-1"></i>
                            Reject
                        </button>
                    </div>
                </div>
            {% elif application.status == 'approved' and not application.created_intern %}
                <div class="action-card">
                    <h5 class="mb-3">Create Intern Account</h5>
                    <p class="small text-muted mb-3">This application has been approved. Create an intern account to complete the process.</p>
                    <div class="text-center">
                        <button class="btn btn-primary" onclick="createInternAccount()">
                            <i class="fas fa-user-plus me-1"></i>
                            Create Account
                        </button>
                    </div>
                </div>
            {% elif application.created_intern %}
                <div class="action-card">
                    <h5 class="mb-3">Intern Account</h5>
                    <p class="small text-success mb-2">
                        <i class="fas fa-check-circle me-1"></i>
                        Account created successfully
                    </p>
                    <p class="small"><strong>Email:</strong> {{ application.created_intern.email }}</p>
                    <p class="small"><strong>Password:</strong> intern2024</p>
                </div>
            {% endif %}

            <!-- Application Timeline -->
            <div class="action-card">
                <h5 class="mb-3">Application Timeline</h5>
                <div class="timeline-item">
                    <h6 class="mb-1">Application Submitted</h6>
                    <small class="text-muted">{{ application.submitted_at|date:"F d, Y \a\t g:i A" }}</small>
                </div>
                {% if application.reviewed_at %}
                    <div class="timeline-item">
                        <h6 class="mb-1">Application Reviewed</h6>
                        <small class="text-muted">{{ application.reviewed_at|date:"F d, Y \a\t g:i A" }}</small>
                        {% if application.reviewed_by %}
                            <br><small class="text-muted">by {{ application.reviewed_by.get_full_name }}</small>
                        {% endif %}
                    </div>
                {% endif %}
                {% if application.created_intern %}
                    <div class="timeline-item">
                        <h6 class="mb-1">Intern Account Created</h6>
                        <small class="text-muted">{{ application.created_intern.date_joined|date:"F d, Y \a\t g:i A" }}</small>
                    </div>
                {% endif %}
            </div>

            <!-- Review Notes -->
            {% if application.review_notes %}
                <div class="action-card">
                    <h5 class="mb-3">Review Notes</h5>
                    <div class="notes-section">
                        {{ application.review_notes|linebreaks }}
                    </div>
                </div>
            {% endif %}

            <!-- Navigation -->
            <div class="action-card">
                <h5 class="mb-3">Navigation</h5>
                <div class="d-grid gap-2">
                    <a href="{% url 'applications:manage' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i>
                        Back to Applications
                    </a>
                    <a href="{% url 'internships:detail' application.internship.pk %}" class="btn btn-outline-info">
                        <i class="fas fa-briefcase me-1"></i>
                        View Internship
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Modals -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approve Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'applications:approve' application.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Are you sure you want to approve this application?</p>
                    <div class="mb-3">
                        <label for="approveNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="approveNotes" name="notes" rows="3" 
                                  placeholder="Add any notes about the approval..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>
                        Approve Application
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'applications:reject' application.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Are you sure you want to reject this application?</p>
                    <div class="mb-3">
                        <label for="rejectNotes" class="form-label">Reason for Rejection *</label>
                        <textarea class="form-control" id="rejectNotes" name="notes" rows="3" 
                                  placeholder="Please provide a reason for rejection..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times me-1"></i>
                        Reject Application
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="createInternModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Intern Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'applications:create_intern' application.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Create an intern account for <strong>{{ application.get_full_name }}</strong>?</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        The intern will receive login credentials via email.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus me-1"></i>
                        Create Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function approveApplication() {
    const modal = new bootstrap.Modal(document.getElementById('approveModal'));
    modal.show();
}

function rejectApplication() {
    const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
    modal.show();
}

function createInternAccount() {
    const modal = new bootstrap.Modal(document.getElementById('createInternModal'));
    modal.show();
}
</script>
{% endblock %}
